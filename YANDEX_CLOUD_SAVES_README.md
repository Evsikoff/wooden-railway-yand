# Интеграция с Яндекс Облаком для сохранения прогресса

## Описание

Система автоматического сохранения и загрузки игрового прогресса с использованием:
1. **Яндекс Облако** (приоритет) - для синхронизации между устройствами
2. **localStorage** (резервное хранилище) - для работы без интернета

## Как это работает

### Загрузка прогресса

При запуске игры система:
1. Пытается загрузить данные из Яндекс Облака
2. Если данных в облаке нет - загружает из localStorage
3. Если нет нигде - считает игрока новым

Все попытки логируются в консоль браузера с подробными сообщениями.

### Сохранение прогресса

При сохранении система:
1. Сохраняет данные в Яндекс Облако
2. Одновременно сохраняет в localStorage
3. Логирует результат каждой операции

## Использование в коде игры

### Загрузка прогресса

Прогресс загружается автоматически при инициализации и доступен через:

```javascript
// Прогресс доступен в глобальной переменной
const savedProgress = window.savedGameProgress;

if (savedProgress) {
    // Восстанавливаем состояние игры
    console.log('Загружен прогресс:', savedProgress);
    // ... ваш код для применения прогресса
} else {
    // Новый игрок, инициализируем с нуля
    console.log('Новый игрок');
}
```

### Сохранение прогресса

```javascript
// Подготовьте данные для сохранения
const progressData = {
    level: 5,
    score: 1000,
    tracks: [...], // ваши данные
    timestamp: Date.now()
};

// Сохраните прогресс
if (window.GameProgressManager) {
    const result = await window.GameProgressManager.saveGameProgress(progressData);

    // result содержит информацию об успешности сохранения
    // result.cloud - сохранено ли в Яндекс Облако
    // result.localStorage - сохранено ли в localStorage
}
```

### Очистка прогресса (для отладки)

```javascript
// Полностью очистить прогресс из обоих хранилищ
if (window.GameProgressManager) {
    await window.GameProgressManager.clearGameProgress();
}
```

## Консольные сообщения

Система выводит подробные сообщения в консоль:

- `✓` - успешная операция
- `✗` - ошибка
- `⚠` - предупреждение
- `ℹ` - информация
- `→` - начало операции

### Примеры сообщений при загрузке:

```
→ Начинаем загрузку прогресса игрока...
→ Попытка загрузить данные из Яндекс Облака...
✓ Данные успешно загружены из Яндекс Облака: {...}
✓ Прогресс игрока найден в Яндекс Облаке
```

### Примеры сообщений при сохранении:

```
→ Начинаем сохранение прогресса игрока... {...}
→ Попытка сохранить данные в Яндекс Облако...
✓ Данные успешно сохранены в Яндекс Облако
→ Попытка сохранить данные в localStorage...
✓ Данные успешно сохранены в localStorage
✓ Прогресс успешно сохранен в оба хранилища
```

## Структура данных

Вы можете сохранять любые данные, которые можно сериализовать в JSON:

```javascript
const progressData = {
    // Общая информация
    version: '1.0',
    timestamp: Date.now(),

    // Игровой прогресс
    level: 1,
    score: 0,

    // Состояние железной дороги
    tracks: [
        { type: 'straight', position: {...} },
        { type: 'curve', position: {...} }
    ],

    // Настройки
    settings: {
        sound: true,
        music: true,
        dayNight: 'day'
    }
};
```

## Технические детали

### Файлы системы

- `yandex-cloud-saves.js` - основной модуль управления сохранениями
- `yandex-sdk-integration.js` - интеграция с Yandex Games SDK
- `index.html` - подключение скриптов

### Ключ хранения

По умолчанию используется ключ `gameProgress` для обоих хранилищ.

### API Яндекса

Используется Player API:
- `player.getData()` - получение данных
- `player.setData(data, flush)` - сохранение данных (flush=true для немедленной записи)

## Отладка

Откройте консоль браузера (F12) для просмотра всех сообщений о загрузке/сохранении.

### Проверка сохраненных данных

```javascript
// Посмотреть что сохранено в localStorage
JSON.parse(localStorage.getItem('gameProgress'))

// Посмотреть текущий загруженный прогресс
window.savedGameProgress

// Проверить доступность менеджера
window.GameProgressManager
```

## Примеры интеграции

### Сохранение при изменении железной дороги

```javascript
// Когда игрок добавляет новый участок пути
function onTrackAdded(trackPiece) {
    // Обновляем состояние
    currentGameState.tracks.push(trackPiece);

    // Сохраняем прогресс
    window.GameProgressManager?.saveGameProgress(currentGameState);
}
```

### Автоматическое сохранение

```javascript
// Автосохранение каждые 30 секунд
setInterval(() => {
    if (window.GameProgressManager && gameStateChanged) {
        window.GameProgressManager.saveGameProgress(currentGameState);
        gameStateChanged = false;
    }
}, 30000);
```

## Обработка ошибок

Все ошибки логируются в консоль. Система устойчива к сбоям:
- Если недоступно Яндекс Облако - используется localStorage
- Если ошибка в localStorage - игра продолжает работать
- Все операции асинхронные и не блокируют игровой процесс
